(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class y extends Error{constructor(e,t){super(e),this.name="AMQPError",this.connection=t}}class k extends DataView{getUint64(e,t){const s=this.getUint32(e,t),n=this.getUint32(e+4,t),i=t?s+2**32*n:2**32*s+n;return Number.isSafeInteger(i)||console.warn(i,"exceeds MAX_SAFE_INTEGER. Precision may be lost"),i}setUint64(e,t,s){this.setBigUint64(e,BigInt(t),s)}getInt64(e,t){return Number(this.getBigInt64(e,t))}setInt64(e,t,s){this.setBigInt64(e,BigInt(t),s)}getShortString(e){const t=this.getUint8(e);if(e+=1,typeof Buffer<"u")return[Buffer.from(this.buffer,this.byteOffset+e,t).toString(),t+1];{const s=new Uint8Array(this.buffer,this.byteOffset+e,t);return[new TextDecoder().decode(s),t+1]}}setShortString(e,t){if(typeof Buffer<"u"){const s=Buffer.byteLength(t);if(s>255)throw new Error(`Short string too long, ${s} bytes: ${t.substring(0,255)}...`);return this.setUint8(e,s),e+=1,Buffer.from(this.buffer,this.byteOffset+e,s).write(t),s+1}else{const s=new TextEncoder().encode(t),n=s.byteLength;if(n>255)throw new Error(`Short string too long, ${n} bytes: ${t.substring(0,255)}...`);return this.setUint8(e,n),e+=1,new Uint8Array(this.buffer,this.byteOffset+e).set(s),n+1}}getLongString(e,t){const s=this.getUint32(e,t);if(e+=4,typeof Buffer<"u")return[Buffer.from(this.buffer,this.byteOffset+e,s).toString(),s+4];{const n=new Uint8Array(this.buffer,this.byteOffset+e,s);return[new TextDecoder().decode(n),s+4]}}setLongString(e,t,s){if(typeof Buffer<"u"){const n=Buffer.byteLength(t);return this.setUint32(e,n,s),e+=4,Buffer.from(this.buffer,this.byteOffset+e,n).write(t),n+4}else{const n=new TextEncoder().encode(t),i=n.byteLength;return this.setUint32(e,i,s),e+=4,new Uint8Array(this.buffer,this.byteOffset+e).set(n),i+4}}getProperties(e,t){let s=e;const n=this.getUint16(s,t);s+=2;const i={};if((n&32768)>0){const[a,o]=this.getShortString(s);s+=o,i.contentType=a}if((n&16384)>0){const[a,o]=this.getShortString(s);s+=o,i.contentEncoding=a}if((n&8192)>0){const[a,o]=this.getTable(s,t);s+=o,i.headers=a}if((n&4096)>0&&(i.deliveryMode=this.getUint8(s),s+=1),(n&2048)>0&&(i.priority=this.getUint8(s),s+=1),(n&1024)>0){const[a,o]=this.getShortString(s);s+=o,i.correlationId=a}if((n&512)>0){const[a,o]=this.getShortString(s);s+=o,i.replyTo=a}if((n&256)>0){const[a,o]=this.getShortString(s);s+=o,i.expiration=a}if((n&128)>0){const[a,o]=this.getShortString(s);s+=o,i.messageId=a}if((n&64)>0&&(i.timestamp=new Date(this.getInt64(s,t)*1e3),s+=8),(n&32)>0){const[a,o]=this.getShortString(s);s+=o,i.type=a}if((n&16)>0){const[a,o]=this.getShortString(s);s+=o,i.userId=a}if((n&8)>0){const[a,o]=this.getShortString(s);s+=o,i.appId=a}const c=s-e;return[i,c]}setProperties(e,t,s){let n=e,i=0;if(t.contentType&&(i=i|32768),t.contentEncoding&&(i=i|16384),t.headers&&(i=i|8192),t.deliveryMode&&(i=i|4096),t.priority&&(i=i|2048),t.correlationId&&(i=i|1024),t.replyTo&&(i=i|512),t.expiration&&(i=i|256),t.messageId&&(i=i|128),t.timestamp&&(i=i|64),t.type&&(i=i|32),t.userId&&(i=i|16),t.appId&&(i=i|8),this.setUint16(n,i,s),n+=2,t.contentType&&(n+=this.setShortString(n,t.contentType)),t.contentEncoding&&(n+=this.setShortString(n,t.contentEncoding)),t.headers&&(n+=this.setTable(n,t.headers)),t.deliveryMode&&(this.setUint8(n,t.deliveryMode),n+=1),t.priority&&(this.setUint8(n,t.priority),n+=1),t.correlationId&&(n+=this.setShortString(n,t.correlationId)),t.replyTo&&(n+=this.setShortString(n,t.replyTo)),t.expiration&&(n+=this.setShortString(n,t.expiration)),t.messageId&&(n+=this.setShortString(n,t.messageId)),t.timestamp){const a=Math.floor(Number(t.timestamp)/1e3);this.setInt64(n,a,s),n+=8}return t.type&&(n+=this.setShortString(n,t.type)),t.userId&&(n+=this.setShortString(n,t.userId)),t.appId&&(n+=this.setShortString(n,t.appId)),n-e}getTable(e,t){const s={};let n=e;const i=this.getUint32(e,t);for(n+=4;n<e+4+i;){const[c,a]=this.getShortString(n);n+=a;const[o,h]=this.getField(n,t);n+=h,s[c]=o}return[s,i+4]}setTable(e,t,s){let n=e+4;for(const[i,c]of Object.entries(t))c!==void 0&&(n+=this.setShortString(n,i),n+=this.setField(n,c,s));return this.setUint32(e,n-e-4,s),n-e}getField(e,t){let s=e;const n=this.getUint8(s);s+=1;const i=String.fromCharCode(n);let c,a;switch(i){case"t":c=this.getUint8(s)===1,s+=1;break;case"b":c=this.getInt8(s),s+=1;break;case"B":c=this.getUint8(s),s+=1;break;case"s":c=this.getInt16(s,t),s+=2;break;case"u":c=this.getUint16(s,t),s+=2;break;case"I":c=this.getInt32(s,t),s+=4;break;case"i":c=this.getUint32(s,t),s+=4;break;case"l":c=this.getInt64(s,t),s+=8;break;case"f":c=this.getFloat32(s,t),s+=4;break;case"d":c=this.getFloat64(s,t),s+=8;break;case"S":[c,a]=this.getLongString(s,t),s+=a;break;case"F":[c,a]=this.getTable(s,t),s+=a;break;case"A":[c,a]=this.getArray(s,t),s+=a;break;case"x":[c,a]=this.getByteArray(s,t),s+=a;break;case"T":c=new Date(this.getInt64(s,t)*1e3),s+=8;break;case"V":c=null;break;case"D":{const o=this.getUint8(s);s+=1;const h=this.getUint32(s,t);s+=4,c=h/10**o;break}default:throw new Error(`Field type '${n}' not supported`)}return[c,s-e]}setField(e,t,s){let n=e;switch(typeof t){case"string":this.setUint8(n,83),n+=1,n+=this.setLongString(n,t,s);break;case"boolean":this.setUint8(n,116),n+=1,this.setUint8(n,t?1:0),n+=1;break;case"bigint":this.setUint8(n,108),n+=1,this.setBigInt64(n,t,s),n+=8;break;case"number":Number.isInteger(t)?-4294967296<t&&t<2**32?(this.setUint8(n,73),n+=1,this.setInt32(n,t,s),n+=4):(this.setUint8(n,108),n+=1,this.setInt64(n,t,s),n+=8):-4294967296<t&&t<2**32?(this.setUint8(n,102),n+=1,this.setFloat32(n,t,s),n+=4):(this.setUint8(n,100),n+=1,this.setFloat64(n,t,s),n+=8);break;case"undefined":this.setUint8(n,86),n+=1;break;case"object":if(Array.isArray(t))this.setUint8(n,65),n+=1,n+=this.setArray(n,t,s);else if(t instanceof Uint8Array)this.setUint8(n,120),n+=1,n+=this.setByteArray(n,t);else if(t instanceof ArrayBuffer)this.setUint8(n,120),n+=1,n+=this.setByteArray(n,new Uint8Array(t));else if(t instanceof Date){this.setUint8(n,84),n+=1;const i=Math.floor(Number(t)/1e3);this.setInt64(n,i,s),n+=8}else t===null?(this.setUint8(n,86),n+=1):(this.setUint8(n,70),n+=1,n+=this.setTable(n,t,s));break;default:throw new Error(`Unsupported field type '${t}'`)}return n-e}getArray(e,t){const s=this.getUint32(e,t);e+=4;const n=e+s,i=[];for(;e<n;){const[c,a]=this.getField(e,t);e+=a,i.push(c)}return[i,s+4]}setArray(e,t,s){const n=e;return e+=4,t.forEach(i=>{e+=this.setField(e,i,s)}),this.setUint32(n,e-n-4,s),e-n}getByteArray(e,t){const s=this.getUint32(e,t);return e+=4,[new Uint8Array(this.buffer,this.byteOffset+e,s),s+4]}setByteArray(e,t,s){return this.setUint32(e,t.byteLength,s),e+=4,new Uint8Array(this.buffer,this.byteOffset+e,t.byteLength).set(t),t.byteLength+4}}var f;(function(r){r[r.METHOD=1]="METHOD",r[r.HEADER=2]="HEADER",r[r.BODY=3]="BODY",r[r.HEARTBEAT=8]="HEARTBEAT"})(f||(f={}));var A;(function(r){r[r.CODE=206]="CODE"})(A||(A={}));var d;(function(r){r[r.CONNECTION=10]="CONNECTION",r[r.CHANNEL=20]="CHANNEL",r[r.EXCHANGE=40]="EXCHANGE",r[r.QUEUE=50]="QUEUE",r[r.BASIC=60]="BASIC",r[r.TX=90]="TX",r[r.CONFIRM=85]="CONFIRM"})(d||(d={}));var U;(function(r){r[r.START=10]="START",r[r.START_OK=11]="START_OK",r[r.SECURE=20]="SECURE",r[r.SECURE_OK=21]="SECURE_OK",r[r.TUNE=30]="TUNE",r[r.TUNE_OK=31]="TUNE_OK",r[r.OPEN=40]="OPEN",r[r.OPEN_OK=41]="OPEN_OK",r[r.CLOSE=50]="CLOSE",r[r.CLOSE_OK=51]="CLOSE_OK",r[r.BLOCKED=60]="BLOCKED",r[r.UNBLOCKED=61]="UNBLOCKED",r[r.UPDATE_SECRET=70]="UPDATE_SECRET",r[r.UPDATE_SECRET_OK=71]="UPDATE_SECRET_OK"})(U||(U={}));var T;(function(r){r[r.OPEN=10]="OPEN",r[r.OPEN_OK=11]="OPEN_OK",r[r.FLOW=20]="FLOW",r[r.FLOW_OK=21]="FLOW_OK",r[r.CLOSE=40]="CLOSE",r[r.CLOSE_OK=41]="CLOSE_OK"})(T||(T={}));var D;(function(r){r[r.DECLARE=10]="DECLARE",r[r.DECLARE_OK=11]="DECLARE_OK",r[r.DELETE=20]="DELETE",r[r.DELETE_OK=21]="DELETE_OK",r[r.BIND=30]="BIND",r[r.BIND_OK=31]="BIND_OK",r[r.UNBIND=40]="UNBIND",r[r.UNBIND_OK=51]="UNBIND_OK"})(D||(D={}));var O;(function(r){r[r.DECLARE=10]="DECLARE",r[r.DECLARE_OK=11]="DECLARE_OK",r[r.BIND=20]="BIND",r[r.BIND_OK=21]="BIND_OK",r[r.PURGE=30]="PURGE",r[r.PURGE_OK=31]="PURGE_OK",r[r.DELETE=40]="DELETE",r[r.DELETE_OK=41]="DELETE_OK",r[r.UNBIND=50]="UNBIND",r[r.UNBIND_OK=51]="UNBIND_OK"})(O||(O={}));var C;(function(r){r[r.QOS=10]="QOS",r[r.QOS_OK=11]="QOS_OK",r[r.CONSUME=20]="CONSUME",r[r.CONSUME_OK=21]="CONSUME_OK",r[r.CANCEL=30]="CANCEL",r[r.CANCEL_OK=31]="CANCEL_OK",r[r.PUBLISH=40]="PUBLISH",r[r.RETURN=50]="RETURN",r[r.DELIVER=60]="DELIVER",r[r.GET=70]="GET",r[r.GET_OK=71]="GET_OK",r[r.GET_EMPTY=72]="GET_EMPTY",r[r.ACK=80]="ACK",r[r.REJECT=90]="REJECT",r[r.RECOVER_ASYNC=100]="RECOVER_ASYNC",r[r.RECOVER=110]="RECOVER",r[r.RECOVER_OK=111]="RECOVER_OK",r[r.NACK=120]="NACK"})(C||(C={}));var v;(function(r){r[r.SELECT=10]="SELECT",r[r.SELECT_OK=11]="SELECT_OK",r[r.COMMIT=20]="COMMIT",r[r.COMMIT_OK=21]="COMMIT_OK",r[r.ROLLBACK=30]="ROLLBACK",r[r.ROLLBACK_OK=31]="ROLLBACK_OK"})(v||(v={}));var R;(function(r){r[r.SELECT=10]="SELECT",r[r.SELECT_OK=11]="SELECT_OK"})(R||(R={}));class m{constructor(e){this.view=new k(new ArrayBuffer(e.bufferSize)),this.offset=0,this.writeUint8(e.type),this.writeUint16(e.channel),this.writeUint32(e.frameSize??0),this.writeUint16(e.classId),this.writeUint16(e.method)}finalize(){if(this.view.getUint32(3)===0){const t=this.offset-7;this.view.setUint32(3,t)}this.view.setUint8(this.offset,A.CODE),this.offset+=1}getBuffer(){return this.view.buffer}toUint8Array(){return new Uint8Array(this.view.buffer,0,this.offset)}writeUint8(e){this.view.setUint8(this.offset,e),this.offset+=1}writeUint16(e){this.view.setUint16(this.offset,e),this.offset+=2}writeUint32(e){this.view.setUint32(this.offset,e),this.offset+=4}writeUint64(e){this.view.setUint64(this.offset,e),this.offset+=8}writeShortString(e){const t=this.view.setShortString(this.offset,e);this.offset+=t}writeLongString(e){const t=this.view.setLongString(this.offset,e);this.offset+=t}writeTable(e){const t=this.view.setTable(this.offset,e);this.offset+=t}}class N{constructor(e,t){this.channel=e,this.name=t}bind(e,t="",s={}){return new Promise((n,i)=>{this.channel.queueBind(this.name,e,t,s).then(()=>n(this)).catch(i)})}unbind(e,t="",s={}){return new Promise((n,i)=>{this.channel.queueUnbind(this.name,e,t,s).then(()=>n(this)).catch(i)})}publish(e,t={}){return new Promise((s,n)=>{this.channel.basicPublish("",this.name,e,t).then(()=>s(this)).catch(n)})}async subscribe(e={},t){return t?this.channel.basicConsume(this.name,e,t):this.channel.basicConsume(this.name,e)}unsubscribe(e){return new Promise((t,s)=>{this.channel.basicCancel(e).then(()=>t(this)).catch(s)})}delete(){return new Promise((e,t)=>{this.channel.queueDelete(this.name).then(()=>e(this)).catch(t)})}get({noAck:e=!0}={}){return this.channel.basicGet(this.name,{noAck:e})}purge(){return this.channel.queuePurge(this.name)}}class P{constructor(e,t,s){this.closed=!1,this.channel=e,this.tag=t,this.onMessage=s}wait(e){return this.closedError?Promise.reject(this.closedError):this.closed?Promise.resolve():new Promise((t,s)=>{if(this.resolveWait=t,this.rejectWait=s,e){const n=()=>s(new y("Timeout",this.channel.connection));this.timeoutId=setTimeout(n,e)}})}cancel(){return this.channel.basicCancel(this.tag)}setClosed(e){this.closed=!0,e&&(this.closedError=e),this.timeoutId&&clearTimeout(this.timeoutId),e?this.rejectWait&&this.rejectWait(e):this.resolveWait&&this.resolveWait()}}class B extends P{constructor(e,t){super(e,t,s=>{this.messageResolver?(this.messageResolver(s),this.messageResolver=null):this.messageQueue&&this.messageQueue.push(s)}),this.messageQueue=[],this.messageResolver=null}get messages(){return this._generator?this._generator:(this._generator=this.generateMessages(),this._generator)}async*generateMessages(){try{for(;!this.closedError&&!this.closed;)if(this.messageQueue.length>0)yield this.messageQueue.shift();else{const e=await new Promise(t=>{this.messageResolver=t});if(this.closedError||this.closed)break;yield e}if(this.closedError)throw this.closedError}finally{try{await this.cancel()}catch{}}}setClosed(e){if(super.setClosed(e),this.messageResolver){const t=this.messageResolver;this.messageResolver=null,t(void 0)}}}class L{constructor(e,t){this.consumers=new Map,this.rpcQueue=Promise.resolve(!0),this.rpcCallbacks=[],this.unconfirmedPublishes=[],this.closed=!1,this.confirmId=0,this.connection=e,this.id=t,this.onerror=s=>{this.logger?.error(`channel ${this.id} closed: ${s}`),this.connection.onerror(new y(`Channel ${this.id} closed: ${s}`,this.connection))}}get logger(){return this.connection.logger}open(){const e=new m({bufferSize:13,type:f.METHOD,channel:this.id,frameSize:5,classId:d.CHANNEL,method:T.OPEN});return e.writeUint8(0),e.finalize(),this.sendRpc(e)}queue(e="",{passive:t=!1,durable:s=e!=="",autoDelete:n=e==="",exclusive:i=e===""}={},c={}){return new Promise((a,o)=>{this.queueDeclare(e,{passive:t,durable:s,autoDelete:n,exclusive:i},c).then(({name:h})=>a(new N(this,h))).catch(o)})}prefetch(e){return this.basicQos(e)}onReturn(e){this.logger?.error("Message returned from server",e)}close(e="",t=200){if(this.closed)return this.rejectClosed();this.closed=!0;const s=new m({bufferSize:512,type:f.METHOD,channel:this.id,classId:d.CHANNEL,method:T.CLOSE});return s.writeUint16(t),s.writeShortString(e),s.writeUint16(0),s.writeUint16(0),s.finalize(),this.sendRpc(s)}basicGet(e,{noAck:t=!0}={}){if(this.closed)return this.rejectClosed();const s=new m({bufferSize:512,type:f.METHOD,channel:this.id,classId:d.BASIC,method:C.GET});return s.writeUint16(0),s.writeShortString(e),s.writeUint8(t?1:0),s.finalize(),this.sendRpc(s)}basicConsume(e,{tag:t="",noAck:s=!0,exclusive:n=!1,args:i={}}={},c){if(this.closed)return this.rejectClosed();const a=new m({bufferSize:4096,type:f.METHOD,channel:this.id,classId:d.BASIC,method:C.CONSUME});a.writeUint16(0),a.writeShortString(e),a.writeShortString(t);let o=0;return s&&(o=o|2),n&&(o=o|4),a.writeUint8(o),a.writeTable(i),a.finalize(),new Promise((h,l)=>{this.sendRpc(a).then(u=>{let E;c?E=new P(this,u,c):E=new B(this,u),this.consumers.set(u,E),h(E)}).catch(l)})}basicCancel(e){if(this.closed)return this.rejectClosed();const t=new m({bufferSize:512,type:f.METHOD,channel:this.id,classId:d.BASIC,method:C.CANCEL});return t.writeShortString(e),t.writeUint8(0),t.finalize(),new Promise((s,n)=>{this.sendRpc(t).then(i=>{const c=this.consumers.get(i);c&&(c.setClosed(),this.consumers.delete(i)),s(this)}).catch(n)})}basicAck(e,t=!1){if(this.closed)return this.rejectClosed();const s=new m({bufferSize:21,type:f.METHOD,channel:this.id,frameSize:13,classId:d.BASIC,method:C.ACK});return s.writeUint64(e),s.writeUint8(t?1:0),s.finalize(),this.connection.send(s.toUint8Array())}basicNack(e,t=!1,s=!1){if(this.closed)return this.rejectClosed();const n=new m({bufferSize:21,type:f.METHOD,channel:this.id,frameSize:13,classId:d.BASIC,method:C.NACK});n.writeUint64(e);let i=0;return s&&(i=i|1),t&&(i=i|2),n.writeUint8(i),n.finalize(),this.connection.send(n.toUint8Array())}basicReject(e,t=!1){if(this.closed)return this.rejectClosed();const s=new m({bufferSize:21,type:f.METHOD,channel:this.id,frameSize:13,classId:d.BASIC,method:C.REJECT});return s.writeUint64(e),s.writeUint8(t?1:0),s.finalize(),this.connection.send(s.toUint8Array())}basicRecover(e=!1){if(this.closed)return this.rejectClosed();const t=new m({bufferSize:13,type:f.METHOD,channel:this.id,frameSize:5,classId:d.BASIC,method:C.RECOVER});return t.writeUint8(e?1:0),t.finalize(),this.sendRpc(t)}async basicPublish(e,t,s,n={},i=!1,c=!1){if(this.closed)return this.rejectClosed();if(this.connection.blocked)return Promise.reject(new y(`Connection blocked by server: ${this.connection.blocked}`,this.connection));let a;if(typeof Buffer<"u"&&s instanceof Buffer)a=s;else if(s instanceof Uint8Array)a=s;else if(s instanceof ArrayBuffer)a=new Uint8Array(s);else if(s===null)a=new Uint8Array(0);else if(typeof s=="string")a=this.connection.textEncoder.encode(s);else throw new TypeError(`Invalid type ${typeof s} for parameter data`);let o=0,h=this.connection.bufferPool.pop()||new k(new ArrayBuffer(this.connection.frameMax));h.setUint8(o,f.METHOD),o+=1,h.setUint16(o,this.id),o+=2,o+=4,h.setUint16(o,d.BASIC),o+=2,h.setUint16(o,C.PUBLISH),o+=2,h.setUint16(o,0),o+=2,o+=h.setShortString(o,e),o+=h.setShortString(o,t);let l=0;i&&(l=l|1),c&&(l=l|2),h.setUint8(o,l),o+=1,h.setUint8(o,A.CODE),o+=1,h.setUint32(3,o-8);const u=o;h.setUint8(o,f.HEADER),o+=1,h.setUint16(o,this.id),o+=2,o+=4,h.setUint16(o,d.BASIC),o+=2,h.setUint16(o,0),o+=2,h.setUint32(o,0),o+=4,h.setUint32(o,a.byteLength),o+=4,o+=h.setProperties(o,n),h.setUint8(o,A.CODE),o+=1,h.setUint32(u+3,o-u-8);let E=new Uint8Array(h.buffer);const b=Math.ceil(a.byteLength/(this.connection.frameMax-8)),S=o+a.byteLength+8*b;if(h.byteLength<S){const p=new ArrayBuffer(S),g=new Uint8Array(p);g.set(E.subarray(0,o)),h=new k(p),E=g}for(let p=0;p<a.byteLength;){const g=Math.min(a.byteLength-p,this.connection.frameMax-8),w=a.subarray(p,p+g);h.setUint8(o,f.BODY),o+=1,h.setUint16(o,this.id),o+=2,h.setUint32(o,g),o+=4,E.set(w,o),o+=g,h.setUint8(o,A.CODE),o+=1,p+=g}const I=this.connection.send(E.subarray(0,o));if(this.confirmId){const p=new Promise((g,w)=>this.unconfirmedPublishes.push([this.confirmId++,g,w]));return I.then(()=>p).finally(()=>this.connection.bufferPool.push(h))}else return I.then(()=>0).finally(()=>this.connection.bufferPool.push(h))}basicQos(e,t=0,s=!1){if(this.closed)return this.rejectClosed();const n=new m({bufferSize:19,type:f.METHOD,channel:this.id,frameSize:11,classId:d.BASIC,method:C.QOS});return n.writeUint32(t),n.writeUint16(e),n.writeUint8(s?1:0),n.finalize(),this.sendRpc(n)}basicFlow(e=!0){if(this.closed)return this.rejectClosed();const t=new m({bufferSize:13,type:f.METHOD,channel:this.id,frameSize:5,classId:d.CHANNEL,method:C.CONSUME});return t.writeUint8(e?1:0),t.finalize(),this.sendRpc(t)}confirmSelect(){if(this.closed)return this.rejectClosed();const e=new m({bufferSize:13,type:f.METHOD,channel:this.id,frameSize:5,classId:d.CONFIRM,method:R.SELECT});return e.writeUint8(0),e.finalize(),this.sendRpc(e)}queueDeclare(e="",{passive:t=!1,durable:s=e!=="",autoDelete:n=e==="",exclusive:i=e===""}={},c={}){if(this.closed)return this.rejectClosed();const a=new m({bufferSize:4096,type:f.METHOD,channel:this.id,classId:d.QUEUE,method:O.DECLARE});a.writeUint16(0),a.writeShortString(e);let o=0;return t&&(o=o|1),s&&(o=o|2),i&&(o=o|4),n&&(o=o|8),a.writeUint8(o),a.writeTable(c),a.finalize(),this.sendRpc(a)}queueDelete(e="",{ifUnused:t=!1,ifEmpty:s=!1}={}){if(this.closed)return this.rejectClosed();const n=new m({bufferSize:512,type:f.METHOD,channel:this.id,classId:d.QUEUE,method:O.DELETE});n.writeUint16(0),n.writeShortString(e);let i=0;return t&&(i=i|1),s&&(i=i|2),n.writeUint8(i),n.finalize(),this.sendRpc(n)}queueBind(e,t,s,n={}){if(this.closed)return this.rejectClosed();const i=new m({bufferSize:4096,type:f.METHOD,channel:this.id,classId:d.QUEUE,method:C.CONSUME});return i.writeUint16(0),i.writeShortString(e),i.writeShortString(t),i.writeShortString(s),i.writeUint8(0),i.writeTable(n),i.finalize(),this.sendRpc(i)}queueUnbind(e,t,s,n={}){if(this.closed)return this.rejectClosed();const i=new m({bufferSize:4096,type:f.METHOD,channel:this.id,classId:d.QUEUE,method:O.UNBIND});return i.writeUint16(0),i.writeShortString(e),i.writeShortString(t),i.writeShortString(s),i.writeTable(n),i.finalize(),this.sendRpc(i)}queuePurge(e){if(this.closed)return this.rejectClosed();const t=new m({bufferSize:512,type:f.METHOD,channel:this.id,classId:d.QUEUE,method:C.CANCEL});return t.writeUint16(0),t.writeShortString(e),t.writeUint8(0),t.finalize(),this.sendRpc(t)}exchangeDeclare(e,t,{passive:s=!1,durable:n=!0,autoDelete:i=!1,internal:c=!1}={},a={}){if(this.closed)return this.rejectClosed();const o=new m({bufferSize:4096,type:f.METHOD,channel:this.id,classId:d.EXCHANGE,method:D.DECLARE});o.writeUint16(0),o.writeShortString(e),o.writeShortString(t);let h=0;return s&&(h=h|1),n&&(h=h|2),i&&(h=h|4),c&&(h=h|8),o.writeUint8(h),o.writeTable(a),o.finalize(),this.sendRpc(o)}exchangeDelete(e,{ifUnused:t=!1}={}){if(this.closed)return this.rejectClosed();const s=new m({bufferSize:512,type:f.METHOD,channel:this.id,classId:d.EXCHANGE,method:C.CONSUME});s.writeUint16(0),s.writeShortString(e);let n=0;return t&&(n=n|1),s.writeUint8(n),s.finalize(),this.sendRpc(s)}exchangeBind(e,t,s="",n={}){if(this.closed)return this.rejectClosed();const i=new m({bufferSize:4096,type:f.METHOD,channel:this.id,classId:d.EXCHANGE,method:C.CANCEL});return i.writeUint16(0),i.writeShortString(e),i.writeShortString(t),i.writeShortString(s),i.writeUint8(0),i.writeTable(n),i.finalize(),this.sendRpc(i)}exchangeUnbind(e,t,s="",n={}){if(this.closed)return this.rejectClosed();const i=new m({bufferSize:4096,type:f.METHOD,channel:this.id,classId:d.EXCHANGE,method:D.UNBIND});return i.writeUint16(0),i.writeShortString(e),i.writeShortString(t),i.writeShortString(s),i.writeUint8(0),i.writeTable(n),i.finalize(),this.sendRpc(i)}txSelect(){return this.txMethod(10)}txCommit(){return this.txMethod(20)}txRollback(){return this.txMethod(30)}txMethod(e){if(this.closed)return this.rejectClosed();const t=new m({bufferSize:12,type:f.METHOD,channel:this.id,frameSize:4,classId:d.TX,method:e});return t.finalize(),this.sendRpc(t)}sendRpc(e){const t=e.toUint8Array();return new Promise((s,n)=>{this.rpcQueue=this.rpcQueue.then(()=>(this.rpcCallbacks.push([s,n]),this.connection.send(t).catch(i=>{const c=this.rpcCallbacks.pop();c?c[1](i):n(i)}))).catch(n)})}setClosed(e){const t=e!==void 0;e||(e=new Error("Connection closed by client")),this.closed||(this.closed=!0,this.consumers.forEach(s=>s.setClosed(e)),this.consumers.clear(),this.rpcCallbacks.forEach(([,s])=>s(e)),this.rpcCallbacks.length=0,this.unconfirmedPublishes.forEach(([,,s])=>s(e)),this.unconfirmedPublishes.length=0,t&&this.onerror(e.message))}rejectClosed(){return Promise.reject(new y("Channel is closed",this.connection))}publishConfirmed(e,t,s){const n=this.unconfirmedPublishes.findIndex(([i])=>i===e);n!==-1?(t?this.unconfirmedPublishes.splice(0,n+1):this.unconfirmedPublishes.splice(n,1)).forEach(([c,a,o])=>{s?o(new Error("Message rejected")):a(c)}):this.logger?.warn("Cant find unconfirmed deliveryTag",e,"multiple:",t,"nack:",s)}onMessageReady(e){this.delivery?(delete this.delivery,this.deliver(e)):this.getMessage?(delete this.getMessage,this.resolveRPC(e)):(delete this.returned,this.onReturn(e))}resolveRPC(e){const t=this.rpcCallbacks.shift();return t&&t[0](e),e}rejectRPC(e){const t=this.rpcCallbacks.shift();return t&&t[1](e),e}deliver(e){queueMicrotask(()=>{const t=this.consumers.get(e.consumerTag);t?t.onMessage(e):this.logger?.warn("Consumer",e.consumerTag,"not available on channel",this.id)})}}class M{constructor(e){this.exchange="",this.routingKey="",this.properties={},this.bodySize=0,this.body=null,this.bodyPos=0,this.deliveryTag=0,this.consumerTag="",this.redelivered=!1,this.channel=e}bodyToString(){return this.body?typeof Buffer<"u"?Buffer.from(this.body).toString():new TextDecoder().decode(this.body):null}bodyString(){return this.bodyToString()}ack(e=!1){return this.channel.basicAck(this.deliveryTag,e)}nack(e=!1,t=!1){return this.channel.basicNack(this.deliveryTag,e,t)}reject(e=!1){return this.channel.basicReject(this.deliveryTag,e)}cancelConsumer(){return this.channel.basicCancel(this.consumerTag)}}const K="3.4.1";class x{constructor(e,t,s,n,i,c=8192,a=0,o=0,h){if(this.closed=!0,this.channelMax=0,this.textEncoder=new TextEncoder,this.bufferPool=[],this.vhost=e,this.username=t,this.password="",Object.defineProperty(this,"password",{value:s,enumerable:!1}),n&&(this.name=n),i&&(this.platform=i),this.logger=h||void 0,this.channels=[new L(this,0)],this.onerror=l=>this.logger?.error("amqp-client connection closed",l.message),c<8192)throw new Error("frameMax must be 8192 or larger");if(this.frameMax=c,a<0)throw new Error("heartbeat must be positive");if(this.heartbeat=a,o&&o<0)throw new Error("channelMax must be positive");this.channelMax=o}channel(e){if(this.closed)return this.rejectClosed();if(e&&e>0){const s=this.channels[e];if(s)return Promise.resolve(s)}if(e||(e=this.channels.findIndex(s=>s===void 0)),e===-1&&(e=this.channels.length),e>this.channelMax&&this.channelMax>0)return Promise.reject(new y("Max number of channels reached",this));const t=new L(this,e);return this.channels[e]=t,t.open()}close(e="",t=200){if(this.closed)return this.rejectClosed();this.closed=!0;const s=new m({bufferSize:512,type:f.METHOD,channel:0,classId:d.CONNECTION,method:U.CLOSE});return s.writeUint16(t),s.writeShortString(e),s.writeUint16(0),s.writeUint16(0),s.finalize(),new Promise((n,i)=>{this.send(s.toUint8Array()).then(()=>this.closePromise=[n,i]).catch(i)})}updateSecret(e,t){const s=new m({bufferSize:8192,type:f.METHOD,channel:0,classId:d.CONNECTION,method:U.UPDATE_SECRET});return s.writeLongString(e),s.writeShortString(t),s.finalize(),new Promise((n,i)=>{this.send(s.toUint8Array()).then(()=>this.onUpdateSecretOk=n).catch(i)})}rejectClosed(){return Promise.reject(new y("Connection closed",this))}rejectConnect(e){if(this.connectPromise){const[,t]=this.connectPromise;delete this.connectPromise,t(e)}this.closed=!0,this.closeSocket()}parseFrames(e){for(let t=0;t<e.byteLength;){const s=e.getUint8(t);t+=1;const n=e.getUint16(t);t+=2;const i=e.getUint32(t);t+=4;let c=0;try{c=e.getUint8(t+i)}catch{throw new y(`Frame end out of range, frameSize=${i}, pos=${t}, byteLength=${e.byteLength}`,this)}if(c!==A.CODE)throw new y(`Invalid frame end ${c}, expected ${A.CODE}`,this);const a=this.channels[n];if(!a){this.logger?.warn("AMQP channel",n,"not open"),t+=i+1;continue}switch(s){case f.METHOD:{const o=e.getUint16(t);t+=2;const h=e.getUint16(t);switch(t+=2,o){case d.CONNECTION:{switch(h){case U.START:{t+=i-4;const l=new m({bufferSize:8192,type:f.METHOD,channel:0,classId:d.CONNECTION,method:U.START_OK}),u={connection_name:this.name||void 0,product:"amqp-client.js",information:"https://github.com/cloudamqp/amqp-client.js",version:K,platform:this.platform,capabilities:{authentication_failure_close:!0,"basic.nack":!0,"connection.blocked":!0,consumer_cancel_notify:!0,exchange_exchange_bindings:!0,per_consumer_qos:!0,publisher_confirms:!0}};l.writeTable(u),l.writeShortString("PLAIN");const E=`\0${this.username}\0${this.password}`;l.writeLongString(E),l.writeShortString(""),l.finalize(),this.send(l.toUint8Array()).catch(this.rejectConnect);break}case U.TUNE:{const l=e.getUint16(t);t+=2;const u=e.getUint32(t);t+=4;const E=e.getUint16(t);t+=2,this.channelMax=this.channelMax===0?l:Math.min(this.channelMax,l),this.frameMax=this.frameMax===0?u:Math.min(this.frameMax,u),this.heartbeat=this.heartbeat===0?0:Math.min(this.heartbeat,E);const b=new m({bufferSize:20,type:f.METHOD,channel:0,frameSize:12,classId:d.CONNECTION,method:U.TUNE_OK});b.writeUint16(this.channelMax),b.writeUint32(this.frameMax),b.writeUint16(this.heartbeat),b.finalize(),this.send(b.toUint8Array()).catch(this.rejectConnect);const S=new m({bufferSize:512,type:f.METHOD,channel:0,classId:d.CONNECTION,method:U.OPEN});S.writeShortString(this.vhost),S.writeUint8(0),S.writeUint8(0),S.finalize(),this.send(S.toUint8Array()).catch(this.rejectConnect);break}case U.OPEN_OK:{t+=1,this.closed=!1;const l=this.connectPromise;if(l){const[u]=l;delete this.connectPromise,u(this)}break}case U.CLOSE:{const l=e.getUint16(t);t+=2;const[u,E]=e.getShortString(t);t+=E;const b=e.getUint16(t);t+=2;const S=e.getUint16(t);t+=2,this.logger?.debug("connection closed by server",l,u,b,S);const I=`connection closed: ${u} (${l})`,p=new y(I,this);this.channels.forEach(w=>w.setClosed(p)),this.channels=[new L(this,0)];const g=new m({bufferSize:12,type:f.METHOD,channel:0,frameSize:4,classId:d.CONNECTION,method:U.CLOSE_OK});g.finalize(),this.send(g.toUint8Array()).catch(w=>this.logger?.warn("Error while sending Connection#CloseOk",w)),this.onerror(p),this.rejectConnect(p),this.onUpdateSecretOk?.();break}case U.CLOSE_OK:{this.channels.forEach(u=>u.setClosed()),this.channels=[new L(this,0)];const l=this.closePromise;if(l){const[u]=l;delete this.closePromise,u(),this.closeSocket()}break}case U.BLOCKED:{const[l,u]=e.getShortString(t);t+=u,this.logger?.warn("AMQP connection blocked:",l),this.blocked=l;break}case U.UNBLOCKED:{this.logger?.info("AMQP connection unblocked"),delete this.blocked;break}case U.UPDATE_SECRET_OK:{this.logger?.info("AMQP connection update secret ok"),this.onUpdateSecretOk?.(),delete this.onUpdateSecretOk;break}default:t+=i-4,this.logger?.error("unsupported class/method id",o,h)}break}case d.CHANNEL:{switch(h){case T.OPEN_OK:{t+=4,a.resolveRPC(a);break}case T.FLOW_OK:{const l=e.getUint8(t)!==0;t+=1,a.resolveRPC(l);break}case T.CLOSE:{const l=e.getUint16(t);t+=2;const[u,E]=e.getShortString(t);t+=E;const b=e.getUint16(t);t+=2;const S=e.getUint16(t);t+=2,this.logger?.debug("channel",n,"closed",l,u,b,S);const I=`channel ${n} closed: ${u} (${l})`,p=new y(I,this);a.setClosed(p),delete this.channels[n];const g=new m({bufferSize:12,type:f.METHOD,channel:n,frameSize:4,classId:d.CHANNEL,method:T.CLOSE_OK});g.finalize(),this.send(g.toUint8Array()).catch(w=>this.logger?.error("Error while sending Channel#closeOk",w));break}case T.CLOSE_OK:{a.setClosed(),delete this.channels[n],a.resolveRPC();break}default:t+=i-4,this.logger?.error("unsupported class/method id",o,h)}break}case d.EXCHANGE:{switch(h){case D.DECLARE_OK:case D.DELETE_OK:case D.BIND_OK:case D.UNBIND_OK:{a.resolveRPC();break}default:t+=i-4,this.logger?.error("unsupported class/method id",o,h)}break}case d.QUEUE:{switch(h){case O.DECLARE_OK:{const[l,u]=e.getShortString(t);t+=u;const E=e.getUint32(t);t+=4;const b=e.getUint32(t);t+=4,a.resolveRPC({name:l,messageCount:E,consumerCount:b});break}case O.BIND_OK:{a.resolveRPC();break}case O.PURGE_OK:{const l=e.getUint32(t);t+=4,a.resolveRPC({messageCount:l});break}case O.DELETE_OK:{const l=e.getUint32(t);t+=4,a.resolveRPC({messageCount:l});break}case O.UNBIND_OK:{a.resolveRPC();break}default:t+=i-4,this.logger?.error("unsupported class/method id",o,h)}break}case d.BASIC:{switch(h){case C.QOS_OK:{a.resolveRPC();break}case C.CONSUME_OK:{const[l,u]=e.getShortString(t);t+=u,a.resolveRPC(l);break}case C.CANCEL:{const[l,u]=e.getShortString(t);t+=u;const E=e.getUint8(t)===1;t+=1;const b=a.consumers.get(l);if(b&&(b.setClosed(new y("Consumer cancelled by the server",this)),a.consumers.delete(l)),!E){const S=new m({bufferSize:512,type:f.METHOD,channel:a.id,classId:d.BASIC,method:C.CANCEL_OK});S.writeShortString(l),S.finalize(),this.send(S.toUint8Array())}break}case C.CANCEL_OK:{const[l,u]=e.getShortString(t);t+=u,a.resolveRPC(l);break}case C.RETURN:{const l=e.getUint16(t);t+=2;const[u,E]=e.getShortString(t);t+=E;const[b,S]=e.getShortString(t);t+=S;const[I,p]=e.getShortString(t);t+=p;const g=new M(a);g.exchange=b,g.routingKey=I,g.replyCode=l,g.replyText=u,a.returned=g;break}case C.DELIVER:{const[l,u]=e.getShortString(t);t+=u;const E=e.getUint64(t);t+=8;const b=e.getUint8(t)===1;t+=1;const[S,I]=e.getShortString(t);t+=I;const[p,g]=e.getShortString(t);t+=g;const w=new M(a);w.consumerTag=l,w.deliveryTag=E,w.exchange=S,w.routingKey=p,w.redelivered=b,a.delivery=w;break}case C.GET_OK:{const l=e.getUint64(t);t+=8;const u=e.getUint8(t)===1;t+=1;const[E,b]=e.getShortString(t);t+=b;const[S,I]=e.getShortString(t);t+=I;const p=e.getUint32(t);t+=4;const g=new M(a);g.deliveryTag=l,g.redelivered=u,g.exchange=E,g.routingKey=S,g.messageCount=p,a.getMessage=g;break}case C.GET_EMPTY:{const[,l]=e.getShortString(t);t+=l,a.resolveRPC(null);break}case C.ACK:{const l=e.getUint64(t);t+=8;const u=e.getUint8(t)===1;t+=1,a.publishConfirmed(l,u,!1);break}case C.RECOVER_OK:{a.resolveRPC();break}case C.NACK:{const l=e.getUint64(t);t+=8;const u=e.getUint8(t)===1;t+=1,a.publishConfirmed(l,u,!0);break}default:t+=i-4,this.logger?.error("unsupported class/method id",o,h)}break}case d.CONFIRM:{switch(h){case R.SELECT_OK:{a.confirmId=1,a.resolveRPC();break}default:t+=i-4,this.logger?.error("unsupported class/method id",o,h)}break}case d.TX:{switch(h){case v.SELECT_OK:case v.COMMIT_OK:case v.ROLLBACK_OK:{a.resolveRPC();break}default:t+=i-4,this.logger?.error("unsupported class/method id",o,h)}break}default:t+=i-2,this.logger?.error("unsupported class id",o)}break}case f.HEADER:{t+=4;const o=e.getUint64(t);t+=8;const[h,l]=e.getProperties(t);t+=l;const u=a.delivery||a.getMessage||a.returned;u?(u.bodySize=o,u.properties=h,u.body=new Uint8Array(o),o===0&&a.onMessageReady(u)):this.logger?.warn("Header frame but no message");break}case f.BODY:{const o=a.delivery||a.getMessage||a.returned;if(o&&o.body){const h=new Uint8Array(e.buffer,e.byteOffset+t,i);o.body.set(h,o.bodyPos),o.bodyPos+=i,t+=i,o.bodyPos===o.bodySize&&a.onMessageReady(o)}else this.logger?.warn("Body frame but no message");break}case f.HEARTBEAT:{const o=new Uint8Array([f.HEARTBEAT,0,0,0,0,0,0,A.CODE]);this.send(o).catch(h=>this.logger?.warn("Error while sending heartbeat",h));break}default:this.logger?.error("invalid frame type:",s),t+=i}t+=1}}}class _ extends x{constructor(e,t="/",s="guest",n="guest",i,c=8192,a=0,o){typeof e=="object"&&(t=e.vhost??t,s=e.username??s,n=e.password??n,i=e.name??i,c=e.frameMax??c,a=e.heartbeat??a,o=e.logger??o,e=e.url),super(t,s,n,i,_.platform(),c,a,0,o),this.framePos=0,this.frameSize=0,this.url=e,this.frameBuffer=new Uint8Array(c)}connect(){const e=new WebSocket(this.url);return this.socket=e,e.binaryType="arraybuffer",e.onmessage=this.handleMessage.bind(this),new Promise((t,s)=>{this.connectPromise=[t,s],e.addEventListener("close",s),e.addEventListener("error",s),e.addEventListener("open",()=>{e.addEventListener("error",n=>{if(!this.closed){const i=new y(n.toString(),this);this.closed=!0,this.channels.forEach(c=>c?.setClosed(i)),this.channels=[new L(this,0)],this.onerror(i)}}),e.addEventListener("close",n=>{const i=this.closed;if(this.closed=!0,n.wasClean&&i)this.channels.forEach(c=>c?.setClosed()),this.channels=[new L(this,0)];else{const c=new y(`connection not cleanly closed (${n.code})`,this);this.channels.forEach(a=>a?.setClosed(c)),this.channels=[new L(this,0)],this.onerror(c)}}),e.send(new Uint8Array([65,77,81,80,0,0,9,1]))})})}send(e){return new Promise((t,s)=>{if(this.socket)try{this.socket.send(e),t()}catch(n){this.closeSocket(),s(n)}else s(new y("Socket not connected",this))})}closeSocket(){this.closed=!0,this.socket&&this.socket.close(),this.socket=void 0}handleMessage(e){const t=e.data,s=new DataView(t);let n=0;for(;n<t.byteLength;){if(this.frameSize===0){if(this.framePos!==0){const a=7-this.framePos;this.frameBuffer.set(new Uint8Array(t,n,a),this.framePos),this.frameSize=new DataView(this.frameBuffer.buffer).getInt32(n+3)+8,this.framePos+=a,n+=a;continue}if(n+3+4>t.byteLength){const a=t.byteLength-n;this.frameBuffer.set(new Uint8Array(t,n),this.framePos),this.framePos+=a;break}if(this.frameSize=s.getInt32(n+3)+8,t.byteLength-n>=this.frameSize){const a=new k(t,n,this.frameSize);this.parseFrames(a),n+=this.frameSize,this.frameSize=0;continue}}const i=this.frameSize-this.framePos,c=Math.min(i,t.byteLength-n);if(this.frameBuffer.set(new Uint8Array(t,n,c),this.framePos),this.framePos+=c,n+=c,this.framePos===this.frameSize){const a=new k(this.frameBuffer.buffer,0,this.frameSize);this.parseFrames(a),this.frameSize=this.framePos=0}}}static platform(){return typeof navigator<"u"?navigator.userAgent:`${process.release.name} ${process.version} ${process.platform} ${process.arch}`}}class z extends EventTarget{constructor(){super(),this.connection=null,this.channel=null,this.isConnected=!1,this.isConnecting=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.oauthToken=null,this.config={hostname:"test-raw-barnacle-01.lmq.cloudamqp.com",port:parseInt("15672")||15672,vhost:"/",username:"guest",password:"guest"}}setOAuthToken(e){this.oauthToken=e}async connect(){if(!(this.isConnected||this.isConnecting)){this.isConnecting=!0,this.dispatchEvent(new CustomEvent("connecting"));try{const e=window.location.protocol==="https:"?"wss":"ws",t=e==="wss"?`${e}://${this.config.hostname}`:`${e}://${this.config.hostname}:${this.config.port}`,s=this.oauthToken?"oauth":this.config.username,n=this.oauthToken||this.config.password;this.connection=new _(t,this.config.vhost,s,n),await this.connection.connect(),this.channel=await this.connection.channel(),this.isConnected=!0,this.isConnecting=!1,this.reconnectAttempts=0,this.dispatchEvent(new CustomEvent("connected")),this.connection.onerror=i=>{this.handleDisconnection()},this.connection.onclose=()=>{this.handleDisconnection()}}catch(e){this.isConnecting=!1,this.dispatchEvent(new CustomEvent("error",{detail:e})),this.scheduleReconnect()}}}handleDisconnection(){this.isConnected&&(this.isConnected=!1,this.isConnecting=!1,this.connection=null,this.channel=null,this.dispatchEvent(new CustomEvent("disconnected")),this.scheduleReconnect())}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return;this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>{this.connect()},e)}async disconnect(){if(this.connection)try{await this.connection.close()}catch{}this.isConnected=!1,this.isConnecting=!1,this.connection=null,this.channel=null}getChannel(){return this.channel}}class $ extends EventTarget{constructor(e){super(),this.amqpConnection=e,this.channels=new Map,this.activeChannel=null,this.messageHandlers=new Map,this.userSessions=new Map,this.userNotificationChannel=null}async createChannel(e){if(console.log("[DEBUG] createChannel called for:",e),this.channels.has(e))return console.log("[DEBUG] Channel already exists:",e),this.channels.get(e);const t=this.amqpConnection.connection;if(!t)throw new Error("AMQP connection not available");const s=`chat-stream-${e}`;console.log("[DEBUG] Creating queue:",s);const n=await t.channel();await n.basicQos(1e3);const i=await n.queue(s,{durable:!0},{"x-queue-type":"stream","x-max-age":"1h"});console.log("[DEBUG] Queue created, binding to exchange"),await i.bind("amq.topic",e),console.log("[DEBUG] Queue bound successfully");const c={name:e,queue:i,consumer:null};return this.channels.set(e,c),console.log("[DEBUG] Channel added to Map, size:",this.channels.size),this.dispatchEvent(new CustomEvent("channelCreated",{detail:{channelName:e}})),c}async subscribeToChannel(e,t){console.log("[DEBUG] subscribeToChannel called for:",e,"username:",t);const s=await this.createChannel(e);if(console.log("[DEBUG] Got channelInfo:",!!s),s.consumer){console.log("[DEBUG] Already subscribed to channel:",e);return}console.log("[DEBUG] Starting subscription...");const n=await s.queue.subscribe({args:{"x-stream-offset":0},noAck:!1},i=>{console.log("Received message:",new Date().toLocaleTimeString(),i.bodyToString()),this.handleMessage(e,i)});console.log("Subscribed to channel:",e),s.consumer=n,this.activeChannel=e,console.log("[DEBUG] Sending join message..."),await this.sendSystemMessage(e,`${t} joined the channel`),this.dispatchEvent(new CustomEvent("channelSubscribed",{detail:{channelName:e}})),console.log("[DEBUG] subscribeToChannel completed")}async unsubscribeFromChannel(e,t){const s=this.channels.get(e);!s||!s.consumer||(await this.sendSystemMessage(e,`${t} left the channel`),await s.consumer.cancel(),s.consumer=null,this.dispatchEvent(new CustomEvent("channelUnsubscribed",{detail:{channelName:e}})))}async sendMessage(e,t,s){console.log("[DEBUG] sendMessage called for channel:",e),console.log("[DEBUG] channels Map size:",this.channels.size),console.log("[DEBUG] channels Map keys:",Array.from(this.channels.keys()));const n=this.channels.get(e);if(console.log("[DEBUG] channelInfo found:",!!n),!n)throw new Error(`Channel ${e} not found`);const i={id:this.generateMessageId(),type:"message",channel:e,username:t,content:s.trim(),timestamp:new Date().toISOString()};await n.queue.publish(JSON.stringify(i),{persistent:!0})}async sendSystemMessage(e,t){const s=this.channels.get(e);if(!s)return;const n={id:this.generateMessageId(),type:"system",channel:e,content:t,timestamp:new Date().toISOString()};await s.queue.publish(JSON.stringify(n),{persistent:!0})}handleMessage(e,t){const s=t.bodyToString(),n=JSON.parse(s);this.dispatchEvent(new CustomEvent("messageReceived",{detail:{channelName:e,message:n}})),t.ack().then(()=>{})}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getChannels(){return Array.from(this.channels.keys())}async subscribeToUserNotifications(e){const t=`user-notifications-${e}`;console.log(`Attempting to subscribe to user notifications for: ${e}, channel: ${t}`);try{const s=await this.createChannel(t);if(s.consumer){console.log(`Already subscribed to notification channel: ${t}`);return}const n=await s.queue.subscribe({args:{"x-stream-offset":0},noAck:!1},i=>{console.log("Received user notification:",new Date().toLocaleTimeString(),i.bodyToString()),this.handleUserNotification(i)});s.consumer=n,this.userNotificationChannel=s,console.log("Successfully subscribed to user notification channel:",t)}catch(s){throw console.error("Failed to subscribe to user notification channel:",s),s}}async sendDMInitiationNotification(e,t,s){const n=`user-notifications-${t}`;console.log(`Attempting to send DM initiation from ${e} to ${t}, channel: ${n}`);try{const i=await this.createChannel(n),c={id:this.generateMessageId(),type:"dm-initiation",from:e,to:t,dmChannel:s,timestamp:new Date().toISOString()};await i.queue.publish(JSON.stringify(c),{persistent:!0}),console.log(`Successfully sent DM initiation notification to ${t}`)}catch(i){console.error("Failed to send DM initiation notification:",i)}}handleUserNotification(e){const t=e.bodyToString(),s=JSON.parse(t);this.dispatchEvent(new CustomEvent("userNotificationReceived",{detail:{notification:s}})),e.ack().then(()=>{})}getActiveChannel(){return this.activeChannel}}class H{constructor(e){this.channelManager=e,this.username=null,this.defaultChannel="general",this.currentChannel=this.defaultChannel,this.activeUsers=new Map,this.directMessages=new Set,this.subscribedChannels=new Set,this.messageBuffers=new Map,this.unreadCounts=new Map,this.initializeElements(),this.bindEvents()}initializeElements(){this.usernameModal=document.getElementById("usernameModal"),this.usernameForm=document.getElementById("usernameForm"),this.usernameInput=document.getElementById("usernameInput"),this.connectionStatus=document.getElementById("connectionStatus"),this.statusIndicator=this.connectionStatus.querySelector(".status-indicator"),this.statusText=this.connectionStatus.querySelector(".status-text"),this.channelList=document.getElementById("channelList"),this.newChannelInput=document.getElementById("newChannelInput"),this.addChannelBtn=document.getElementById("addChannelBtn"),this.currentChannelName=document.getElementById("currentChannelName"),this.usersList=document.getElementById("usersList"),this.dmList=document.getElementById("dmList"),this.messagesContainer=document.getElementById("messagesContainer"),this.messageForm=document.getElementById("messageForm"),this.messageInput=document.getElementById("messageInput"),this.sendButton=document.getElementById("sendButton"),this.userCount=document.getElementById("userCount")}bindEvents(){this.usernameForm.addEventListener("submit",e=>{e.preventDefault(),this.handleUsernameSubmit()}),this.addChannelBtn.addEventListener("click",()=>{this.handleAddChannel()}),this.newChannelInput.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleAddChannel()}),this.messageForm.addEventListener("submit",e=>{e.preventDefault(),this.handleMessageSubmit()}),this.messageInput.addEventListener("input",()=>{this.updateSendButtonState()}),this.channelList.addEventListener("click",e=>{const t=e.target.closest(".channel-item");if(t){const s=t.dataset.channel;this.switchChannel(s)}}),this.usersList.addEventListener("click",e=>{const t=e.target.closest(".user-item");if(t&&!t.classList.contains("current-user")){const s=t.querySelector(".user-name").textContent;this.startDirectMessage(s)}}),this.dmList.addEventListener("click",e=>{const t=e.target.closest(".dm-item");if(t){const s=t.dataset.username,n=this.getDMChannelName(s);this.switchChannel(n)}}),this.channelManager.addEventListener("messageReceived",e=>{this.handleMessageReceived(e.detail)}),this.channelManager.addEventListener("channelCreated",e=>{this.addChannelToUI(e.detail.channelName)}),this.channelManager.addEventListener("channelUnsubscribed",e=>{this.handleChannelUnsubscribed(e.detail.channelName)}),this.channelManager.addEventListener("userNotificationReceived",e=>{this.handleUserNotification(e.detail.notification)})}showUsernameModal(e=!1,t=null){if(t&&(this._oauthLoginCallback=t),e){this.usernameInput.style.display="none";const s=this.usernameModal.querySelector('button[type="submit"]');s&&(s.style.display="none");let n=this.usernameModal.querySelector(".oauth-login-btn");n||(n=document.createElement("button"),n.type="button",n.className="oauth-login-btn",n.textContent="Sign in with GitHub",n.style.cssText=`
          padding: 12px 24px;
          background: #24292e;
          color: white;
          border: none;
          border-radius: 6px;
          font-size: 16px;
          cursor: pointer;
          margin-top: 10px;
        `,n.addEventListener("click",()=>{this._oauthLoginCallback&&this._oauthLoginCallback()}),this.usernameModal.querySelector(".modal-content").appendChild(n))}this.usernameModal.style.display="flex",e||this.usernameInput.focus()}hideUsernameModal(){this.usernameModal.style.display="none"}async handleUsernameSubmit(){console.log("[DEBUG] handleUsernameSubmit called");const e=this.username||this.usernameInput.value.trim();if(!e||e.length>20){console.log("[DEBUG] Invalid username:",e,"length:",e?.length);return}this.username=e,console.log("[DEBUG] Username set to:",e),this.hideUsernameModal(),document.title=`${e} - WamsChat - AMQP Stream Chat`;try{console.log("[DEBUG] About to subscribe to default channel:",this.defaultChannel),await this.channelManager.subscribeToChannel(this.defaultChannel,this.username),console.log("[DEBUG] Subscribed to default channel"),this.subscribedChannels.add(this.defaultChannel),console.log("[DEBUG] About to subscribe to user notifications"),await this.channelManager.subscribeToUserNotifications(this.username),console.log("[DEBUG] Subscribed to user notifications"),this.addChannelToUI(this.defaultChannel),this.updateChannelUI(this.defaultChannel),this.activeUsers.set(e,Date.now()),this.updateUserCount(),this.updateUsersList(),this.enableChatInterface(),console.log("[DEBUG] handleUsernameSubmit completed successfully")}catch(t){console.error("Failed to join channel:",t),console.error("[DEBUG] Error stack:",t.stack),this.showError("Failed to join chat. Please try again.")}}async handleAddChannel(){const e=this.newChannelInput.value.trim().toLowerCase();if(!(!e||e.length>50)){if(!/^[a-z0-9-]+$/.test(e)){this.showError("Channel name can only contain letters, numbers, and dashes");return}try{await this.channelManager.createChannel(e),this.newChannelInput.value="",this.switchChannel(e)}catch(t){console.error("Failed to create channel:",t),this.showError("Failed to create channel")}}}async handleMessageSubmit(){const e=this.messageInput.value.trim();if(!(!e||e.length>1e3))try{await this.channelManager.sendMessage(this.currentChannel,this.username,e),this.messageInput.value="",this.updateSendButtonState()}catch(t){console.error("Failed to send message:",t),this.showError("Failed to send message")}}async switchChannel(e){if(e.startsWith("user-notifications-")||this.currentChannel===e)return;const t=this.isDMChannel(e);if(!this.subscribedChannels.has(e))try{await this.channelManager.subscribeToChannel(e,this.username),this.subscribedChannels.add(e)}catch(s){console.error("Failed to subscribe to channel:",s),this.showError(t?"Failed to start direct message":"Failed to join channel");return}this.currentChannel=e,this.updateChannelUI(e),this.clearMessages(),this.loadBufferedMessages(e),this.unreadCounts.set(e,0),this.updateUnreadIndicator(e)}updateChannelUI(e){const t=this.isDMChannel(e);if(document.querySelectorAll(".channel-item").forEach(s=>{s.classList.toggle("active",!t&&s.dataset.channel===e)}),document.querySelectorAll(".dm-item").forEach(s=>{const n=s.dataset.username,i=this.getDMChannelName(n);s.classList.toggle("active",t&&i===e)}),t){const s=this.getDMUsernameFromChannel(e);this.currentChannelName.textContent=`@ ${s}`}else this.currentChannelName.textContent=`# ${e}`;this.updateUserCount(),this.updateUsersList()}addChannelToUI(e){if(e.startsWith("user-notifications-")||this.isDMChannel(e)||document.querySelector(`[data-channel="${e}"]`))return;const t=document.createElement("div");t.className="channel-item",t.dataset.channel=e,e===this.defaultChannel?t.innerHTML=`
        <span class="channel-hash">#</span>
        <span class="channel-name">${e}</span>
      `:(t.innerHTML=`
        <span class="channel-hash">#</span>
        <span class="channel-name">${e}</span>
        <button class="channel-leave-btn" type="button" title="Leave channel">Ã—</button>
      `,t.querySelector(".channel-leave-btn").addEventListener("click",n=>{n.stopPropagation(),this.leaveChannel(e)})),this.channelList.appendChild(t)}handleMessageReceived({channelName:e,message:t}){e.startsWith("user-notifications-")||(this.updateActiveUsers(e,t),this.messageBuffers.has(e)||this.messageBuffers.set(e,[]),this.unreadCounts.has(e)||this.unreadCounts.set(e,0),this.messageBuffers.get(e).push(t),e===this.currentChannel?this.displayMessage(t):(this.unreadCounts.set(e,this.unreadCounts.get(e)+1),this.updateUnreadIndicator(e)))}displayMessage(e){if(e.type==="system"&&this.isDMChannel(this.currentChannel)){const n=e.content;if(n.includes(" joined the channel")||n.includes(" left the channel"))return}const t=document.createElement("div");e.type==="system"?(t.className="system-message",t.textContent=e.content):(t.className="message",t.innerHTML=`
        <div class="message-header">
          <span class="message-author">${this.escapeHtml(e.username)}</span>
          <span class="message-timestamp">${this.formatTimestamp(e.timestamp)}</span>
        </div>
        <div class="message-content">${this.escapeHtml(e.content)}</div>
      `);const s=this.messagesContainer.querySelector(".welcome-message");s&&s.remove(),this.messagesContainer.appendChild(t),this.scrollToBottom()}clearMessages(){this.messagesContainer.innerHTML=""}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}updateConnectionStatus(e){this.statusIndicator.className=`status-indicator ${e}`;const t={connected:"Connected",connecting:"Connecting...",disconnected:"Disconnected",error:"Connection Error"};this.statusText.textContent=t[e]||"Unknown"}enableChatInterface(){this.messageInput.disabled=!1,this.updateSendButtonState()}disableChatInterface(){this.messageInput.disabled=!0,this.sendButton.disabled=!0}updateSendButtonState(){const t=this.messageInput.value.trim().length>0&&!this.messageInput.disabled;this.sendButton.disabled=!t}showError(e){if(console.error("UI Error:",e),this.currentChannel){const t={type:"system",content:`Error: ${e}`,timestamp:new Date().toISOString()};this.displayMessage(t)}}formatTimestamp(e){const t=new Date(e),s=new Date;return t.toDateString()===s.toDateString()?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric"})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async leaveChannel(e){if(e===this.defaultChannel){this.showError(`Cannot leave the ${this.defaultChannel} channel`);return}if(!this.isDMChannel(e)&&!e.startsWith("user-notifications-"))try{await this.channelManager.unsubscribeFromChannel(e,this.username),this.subscribedChannels.delete(e),this.activeUsers.delete(e),this.currentChannel===e&&await this.switchChannel(this.defaultChannel);const t=document.querySelector(`[data-channel="${e}"]`);t&&t.remove()}catch(t){console.error("Failed to leave channel:",t),this.showError("Failed to leave channel")}}getDMChannelName(e){const t=[this.username,e].sort();return`dm-${t[0]}-${t[1]}`}async startDirectMessage(e){if(e===this.username)return;this.directMessages.has(e)||(this.directMessages.add(e),this.addDMToUI(e));const t=this.getDMChannelName(e);try{await this.channelManager.sendDMInitiationNotification(this.username,e,t)}catch(s){console.error("Failed to send DM initiation notification:",s)}await this.switchChannel(t)}addDMToUI(e){if(document.querySelector(`[data-username="${e}"]`))return;const t=document.createElement("div");t.className="dm-item",t.dataset.username=e,t.innerHTML=`
      <span class="dm-avatar">@</span>
      <span class="dm-username">${this.escapeHtml(e)}</span>
    `,this.dmList.appendChild(t)}isDMChannel(e){return e.startsWith("dm-")}getDMUsernameFromChannel(e){if(!this.isDMChannel(e))return null;const t=e.split("-");if(t.length===3){const[,s,n]=t;return s===this.username?n:s}return null}getUsername(){return this.username}setUsername(e){this.username=e}handleChannelUnsubscribed(e){}handleUserNotification(e){if(console.log("Processing user notification:",e),e.type==="dm-initiation"){const t=e.from,s=e.dmChannel;console.log(`Received DM initiation from ${t}, channel: ${s}`),this.directMessages.has(t)||(this.directMessages.add(t),this.addDMToUI(t),console.log(`Added ${t} to DM list`)),this.subscribedChannels.has(s)?console.log(`Already subscribed to DM channel: ${s}`):(console.log(`Auto-subscribing to DM channel: ${s}`),this.channelManager.subscribeToChannel(s,this.username).then(()=>{this.subscribedChannels.add(s),console.log(`Successfully auto-subscribed to DM channel from ${t}`)}).catch(n=>{console.error("Failed to auto-subscribe to DM channel:",n)}))}}updateActiveUsers(e,t){if(!e.startsWith("user-notifications-")){if(this.isDMChannel(e)&&t.type==="message"&&t.username&&t.username!==this.username){const s=t.username;this.directMessages.has(s)||(this.directMessages.add(s),this.addDMToUI(s)),this.subscribedChannels.has(e)||this.channelManager.subscribeToChannel(e,this.username).then(()=>{this.subscribedChannels.add(e)}).catch(n=>{console.error("Failed to subscribe to DM channel:",n)})}if(t.type==="system"){const s=t.content,n=s.match(/^(.+) left the channel$/);if(n){const c=n[1];this.activeUsers.delete(c),this.updateUserCount(),this.updateUsersList();return}const i=s.match(/^(.+) joined the channel$/);if(i){const c=i[1];this.activeUsers.set(c,Date.now()),this.updateUserCount(),this.updateUsersList();return}return}t.type==="message"&&t.username&&(this.activeUsers.set(t.username,Date.now()),this.updateUserCount(),this.updateUsersList())}}updateUserCount(){const e=this.activeUsers.size,t=e===1?"1 user":`${e} users`;this.userCount.textContent=t}updateUsersList(){if(this.usersList.innerHTML="",this.activeUsers.size===0){const t=document.createElement("div");t.className="users-empty",t.textContent="No active users",this.usersList.appendChild(t);return}Array.from(this.activeUsers.keys()).sort((t,s)=>t===this.username?-1:s===this.username?1:t.localeCompare(s)).forEach(t=>{const s=document.createElement("div");s.className="user-item",t===this.username&&s.classList.add("current-user"),s.innerHTML=`
        <span class="user-avatar">@</span>
        <span class="user-name">${this.escapeHtml(t)}</span>
      `,this.usersList.appendChild(s)})}loadBufferedMessages(e){const t=this.messageBuffers.get(e);t&&t.length>0&&t.forEach(s=>{this.displayMessage(s)})}updateUnreadIndicator(e){const t=this.unreadCounts.get(e)||0;if(this.isDMChannel(e)){const n=this.getDMUsernameFromChannel(e),i=document.querySelector(`[data-username="${n}"]`);i&&this.updateItemUnreadIndicator(i,t)}else{const n=document.querySelector(`[data-channel="${e}"]`);n&&this.updateItemUnreadIndicator(n,t)}}updateItemUnreadIndicator(e,t){const s=e.querySelector(".unread-indicator");if(s&&s.remove(),t>0){const n=document.createElement("span");n.className="unread-indicator",n.textContent=t>99?"99+":t.toString(),e.appendChild(n)}}}class F{constructor(){this.clientId="wamschat-prod",this.authorizationEndpoint="https://test-giant-beige-hawk.rmq7.cloudamqp.com/realms/lavinmq-dev/protocol/openid-connect/auth",this.tokenEndpoint="https://test-giant-beige-hawk.rmq7.cloudamqp.com/realms/lavinmq-dev/protocol/openid-connect/token",this.redirectUri="https://demo.lavinmq.com/chat/callback",this.scope="openid profile email",this.TOKEN_KEY="oauth_access_token",this.USERNAME_KEY="oauth_username",this.CODE_VERIFIER_KEY="pkce_code_verifier"}generateCodeVerifier(){const e=new Uint8Array(32);return crypto.getRandomValues(e),this.base64URLEncode(e)}async generateCodeChallenge(e){const s=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",s);return this.base64URLEncode(new Uint8Array(n))}base64URLEncode(e){return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async startOAuthFlow(){if(!this.clientId||!this.authorizationEndpoint)throw new Error("OAuth not configured. Set VITE_OAUTH_CLIENT_ID and VITE_OAUTH_AUTH_URL in .env");const e=this.generateCodeVerifier();sessionStorage.setItem(this.CODE_VERIFIER_KEY,e);const t=await this.generateCodeChallenge(e),s=new URLSearchParams({client_id:this.clientId,redirect_uri:this.redirectUri,scope:this.scope,response_type:"code",code_challenge:t,code_challenge_method:"S256"}),n=`${this.authorizationEndpoint}?${s.toString()}`;window.location.href=n}async handleCallback(){const e=new URLSearchParams(window.location.search),t=e.get("code"),s=e.get("error");if(s)throw new Error(`OAuth error: ${s}`);if(!t)throw new Error("No authorization code received");const n=sessionStorage.getItem(this.CODE_VERIFIER_KEY);if(!n)throw new Error("Code verifier not found. Please restart the OAuth flow.");const i=new URLSearchParams({client_id:this.clientId,code:t,redirect_uri:this.redirectUri,grant_type:"authorization_code",code_verifier:n}),c=await fetch(this.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:i.toString()});if(!c.ok){const o=await c.text();throw new Error(`Token exchange failed: ${c.status} ${o}`)}const a=await c.json();localStorage.setItem(this.TOKEN_KEY,a.access_token);try{const o=this.extractUsernameFromToken(a.access_token);this.setUsername(o)}catch(o){console.warn("Could not extract username from token:",o)}return sessionStorage.removeItem(this.CODE_VERIFIER_KEY),window.history.replaceState({},document.title,window.location.pathname),a.access_token}extractUsernameFromToken(e){try{const t=e.split(".");if(t.length!==3)throw new Error("Invalid JWT format");const s=JSON.parse(atob(t[1]));return s.preferred_username||s.email||s.sub||"oauth-user"}catch(t){return console.error("Failed to decode JWT:",t),"oauth-user"}}getAccessToken(){return localStorage.getItem(this.TOKEN_KEY)}getUsername(){return localStorage.getItem(this.USERNAME_KEY)}setUsername(e){localStorage.setItem(this.USERNAME_KEY,e)}isAuthenticated(){return!!this.getAccessToken()}logout(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USERNAME_KEY),sessionStorage.removeItem(this.CODE_VERIFIER_KEY)}isCallback(){const e=new URLSearchParams(window.location.search);return e.has("code")||e.has("error")}}class q{constructor(){this.amqpConnection=new z,this.channelManager=new $(this.amqpConnection),this.uiManager=new H(this.channelManager),this.oauthClient=new F,this.bindConnectionEvents(),this.initialize()}bindConnectionEvents(){this.amqpConnection.addEventListener("connecting",()=>{console.log("Connecting to AMQP broker..."),this.uiManager.updateConnectionStatus("connecting")}),this.amqpConnection.addEventListener("connected",()=>{console.log("Connected to AMQP broker"),this.uiManager.updateConnectionStatus("connected"),this.uiManager.enableChatInterface()}),this.amqpConnection.addEventListener("disconnected",()=>{console.log("Disconnected from AMQP broker"),this.uiManager.updateConnectionStatus("disconnected"),this.uiManager.disableChatInterface()}),this.amqpConnection.addEventListener("error",e=>{console.error("AMQP connection error:",e.detail),this.uiManager.updateConnectionStatus("error"),this.uiManager.showError("Connection failed. Please check the AMQP broker.")})}async initialize(){try{if(this.oauthClient.isCallback())try{const t=await this.oauthClient.handleCallback(),s=this.oauthClient.getUsername();this.amqpConnection.setOAuthToken(t),console.log("OAuth authentication successful for user:",s),await this.amqpConnection.connect(),this.uiManager.setUsername(s),this.uiManager.hideUsernameModal(),await this.uiManager.handleUsernameSubmit();return}catch(t){console.error("OAuth callback failed:",t),this.uiManager.showError(`OAuth authentication failed: ${t.message}`);return}if(this.oauthClient.isAuthenticated()){const t=this.oauthClient.getAccessToken(),s=this.oauthClient.getUsername();this.amqpConnection.setOAuthToken(t),await this.amqpConnection.connect(),this.uiManager.setUsername(s),this.uiManager.hideUsernameModal(),await this.uiManager.handleUsernameSubmit();return}this.uiManager.showUsernameModal(!0,()=>this.oauthClient.startOAuthFlow())}catch(e){console.error("Failed to initialize app:",e),this.uiManager.showError("Failed to start the application")}}async shutdown(){console.log("Shutting down WamsChat...");const e=this.uiManager.getUsername();if(e){const t=this.channelManager.getChannels();for(const s of t)try{await this.channelManager.unsubscribeFromChannel(s,e)}catch(n){console.error(`Failed to unsubscribe from ${s}:`,n)}}await this.amqpConnection.disconnect()}}document.addEventListener("DOMContentLoaded",()=>{const r=new q;window.addEventListener("beforeunload",()=>{r.shutdown()}),window.wamsChatApp=r});
